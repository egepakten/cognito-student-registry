AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: WiseUni - Main Stack (Nested Stacks)
Parameters:
  ProjectName:
    Type: String
    Default: wiseuni
    Description: Project name used for resource naming
  Environment:
    Type: String
    Default: dev
    AllowedValues:
    - dev
    - staging
    - prod
    Description: Environment name (dev, staging, prod)
Resources:
  LambdaTriggersStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://s3.us-east-1.amazonaws.com/wiseuni-deploy-116981775669/00294b77bd734beb34b0ed39bba5a34f.template
      Parameters:
        ProjectName:
          Ref: ProjectName
        Environment:
          Ref: Environment
      Tags:
      - Key: Project
        Value:
          Ref: ProjectName
      - Key: Environment
        Value:
          Ref: Environment
  CognitoStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://s3.us-east-1.amazonaws.com/wiseuni-deploy-116981775669/4ad477e5a4bea47a00fee078a47d7665.template
      Parameters:
        ProjectName:
          Ref: ProjectName
        Environment:
          Ref: Environment
        PreSignUpFunctionArn:
          Fn::GetAtt:
          - LambdaTriggersStack
          - Outputs.PreSignUpFunctionArn
        PostConfirmationFunctionArn:
          Fn::GetAtt:
          - LambdaTriggersStack
          - Outputs.PostConfirmationFunctionArn
        PreAuthenticationFunctionArn:
          Fn::GetAtt:
          - LambdaTriggersStack
          - Outputs.PreAuthenticationFunctionArn
        CustomMessageFunctionArn:
          Fn::GetAtt:
          - LambdaTriggersStack
          - Outputs.CustomMessageFunctionArn
      Tags:
      - Key: Project
        Value:
          Ref: ProjectName
      - Key: Environment
        Value:
          Ref: Environment
  DatabaseStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://s3.us-east-1.amazonaws.com/wiseuni-deploy-116981775669/ad65323111fe997fa86beafa789458cd.template
      Parameters:
        ProjectName:
          Ref: ProjectName
        Environment:
          Ref: Environment
      Tags:
      - Key: Project
        Value:
          Ref: ProjectName
      - Key: Environment
        Value:
          Ref: Environment
  StorageStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://s3.us-east-1.amazonaws.com/wiseuni-deploy-116981775669/368d005e6509f24a7d3b480520967eb5.template
      Parameters:
        ProjectName:
          Ref: ProjectName
        Environment:
          Ref: Environment
      Tags:
      - Key: Project
        Value:
          Ref: ProjectName
      - Key: Environment
        Value:
          Ref: Environment
  IAMRolesStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://s3.us-east-1.amazonaws.com/wiseuni-deploy-116981775669/dad3b8fa54b968dd9fff6057a28e2de2.template
      Parameters:
        ProjectName:
          Ref: ProjectName
        Environment:
          Ref: Environment
        IdentityPoolId:
          Fn::GetAtt:
          - CognitoStack
          - Outputs.IdentityPoolId
        WiseUniTableArn:
          Fn::GetAtt:
          - DatabaseStack
          - Outputs.WiseUniTableArn
        HomeworkBucketArn:
          Fn::GetAtt:
          - StorageStack
          - Outputs.HomeworkBucketArn
      Tags:
      - Key: Project
        Value:
          Ref: ProjectName
      - Key: Environment
        Value:
          Ref: Environment
  FrontendStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://s3.us-east-1.amazonaws.com/wiseuni-deploy-116981775669/dcb1a50e9c9f14cdcc02273f55b7212a.template
      Parameters:
        ProjectName:
          Ref: ProjectName
        Environment:
          Ref: Environment
      Tags:
      - Key: Project
        Value:
          Ref: ProjectName
      - Key: Environment
        Value:
          Ref: Environment
Outputs:
  UserPoolId:
    Description: Cognito User Pool ID
    Value:
      Fn::GetAtt:
      - CognitoStack
      - Outputs.UserPoolId
    Export:
      Name:
        Fn::Sub: ${ProjectName}-UserPoolId-${Environment}
  UserPoolClientId:
    Description: Cognito User Pool Client ID
    Value:
      Fn::GetAtt:
      - CognitoStack
      - Outputs.UserPoolClientId
    Export:
      Name:
        Fn::Sub: ${ProjectName}-UserPoolClientId-${Environment}
  IdentityPoolId:
    Description: Cognito Identity Pool ID
    Value:
      Fn::GetAtt:
      - CognitoStack
      - Outputs.IdentityPoolId
    Export:
      Name:
        Fn::Sub: ${ProjectName}-IdentityPoolId-${Environment}
  UserPoolDomain:
    Description: Cognito User Pool Domain
    Value:
      Fn::GetAtt:
      - CognitoStack
      - Outputs.UserPoolDomain
    Export:
      Name:
        Fn::Sub: ${ProjectName}-UserPoolDomain-${Environment}
  WiseUniTableName:
    Description: DynamoDB Table Name
    Value:
      Fn::GetAtt:
      - DatabaseStack
      - Outputs.WiseUniTableName
    Export:
      Name:
        Fn::Sub: ${ProjectName}-TableName-${Environment}
  WiseUniTableArn:
    Description: DynamoDB Table ARN
    Value:
      Fn::GetAtt:
      - DatabaseStack
      - Outputs.WiseUniTableArn
    Export:
      Name:
        Fn::Sub: ${ProjectName}-TableArn-${Environment}
  HomeworkBucketName:
    Description: S3 Bucket Name (for file uploads)
    Value:
      Fn::GetAtt:
      - StorageStack
      - Outputs.HomeworkBucketName
    Export:
      Name:
        Fn::Sub: ${ProjectName}-BucketName-${Environment}
  HomeworkBucketArn:
    Description: S3 Bucket ARN
    Value:
      Fn::GetAtt:
      - StorageStack
      - Outputs.HomeworkBucketArn
    Export:
      Name:
        Fn::Sub: ${ProjectName}-BucketArn-${Environment}
  StudentRoleArn:
    Description: Student IAM Role ARN
    Value:
      Fn::GetAtt:
      - IAMRolesStack
      - Outputs.StudentRoleArn
    Export:
      Name:
        Fn::Sub: ${ProjectName}-StudentRoleArn-${Environment}
  ProfessorRoleArn:
    Description: Professor IAM Role ARN
    Value:
      Fn::GetAtt:
      - IAMRolesStack
      - Outputs.ProfessorRoleArn
    Export:
      Name:
        Fn::Sub: ${ProjectName}-ProfessorRoleArn-${Environment}
  AdminRoleArn:
    Description: Admin IAM Role ARN
    Value:
      Fn::GetAtt:
      - IAMRolesStack
      - Outputs.AdminRoleArn
    Export:
      Name:
        Fn::Sub: ${ProjectName}-AdminRoleArn-${Environment}
  FrontendBucketName:
    Description: S3 bucket for frontend static files
    Value:
      Fn::GetAtt:
      - FrontendStack
      - Outputs.FrontendBucketName
    Export:
      Name:
        Fn::Sub: ${ProjectName}-FrontendBucketName-${Environment}
  CloudFrontDistributionId:
    Description: CloudFront distribution ID
    Value:
      Fn::GetAtt:
      - FrontendStack
      - Outputs.CloudFrontDistributionId
    Export:
      Name:
        Fn::Sub: ${ProjectName}-CloudFrontDistributionId-${Environment}
  CloudFrontDomainName:
    Description: CloudFront domain name
    Value:
      Fn::GetAtt:
      - FrontendStack
      - Outputs.CloudFrontDomainName
    Export:
      Name:
        Fn::Sub: ${ProjectName}-CloudFrontDomain-${Environment}
  WebsiteURL:
    Description: üåê Your WiseUni website URL (click to visit!)
    Value:
      Fn::GetAtt:
      - FrontendStack
      - Outputs.WebsiteURL
    Export:
      Name:
        Fn::Sub: ${ProjectName}-WebsiteURL-${Environment}
